{% extends "base.html" %}

{% block head %}
    {{ super() }}
    <base target="_parent">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.3.0/css/all.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.11/index.global.min.js"></script>
{% endblock head %}

{% block title %}{{ title }}{% endblock title %}

{% block content %}
    {{ super() }}
    <div id="calendar"></div>
{% endblock content %}

{% block script %}

    <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>


    <script>
    window.addEventListener("load", () => {
        var calendar = new FullCalendar.Calendar ( $('#calendar'), {
            editable:true,
            header:{
                left:'prev, next today',
                center:'title',
                right:'month, agendaWeek, agendaDay'
            },
            events: [{% for row in calendar %}{ id : '{{row.id}}', title : '{{row.nom}}', start: '{{row.ddv}}', end : '{{row.rdv}}',},{% endfor %}],
            // Allows a user to highlight multiple days or timeslots by clicking and dragging.
            selectable:true,
            //Whether to draw a “placeholder” event while the user is dragging.
            selectHelper:true,
            select: function(start, end, allDay)
            {
                var title = prompt("Enter event title");
                if(title)
                {
                    var start = $.fullCalendar.formatDate(start, 'Y/MM/DD HH:mm:ss');
                    var end = $.fullCalendar.formatDate(end, 'Y/MM/DD HH:mm:ss');
                    $.ajax({
                        url:"/insert",
                        type:"POST",
                        data:{title:title, start:start, end:end},
                        success:function(data)
                        {
                            alert("Added Successfully");
                            window.location.replace("/");
                        }
                    })
                }
            },
            editable:true,
            eventResize:function(event)
            {
                var start = $.fullCalendar.formatDate(event.start, 'Y/MM/DD HH:mm:ss');
                var end = $.fullCalendar.formatDate(event.end, 'Y/MM/DD HH:mm:ss');
                var title = event.title;
                var id = event.id;
                $.ajax({
                    url:"/update",
                    type:"POST",
                    data:{title:title, start:start, end:end, id:id},
                    success:function(){
                        calendar.fullCalendar('refetchEvents');
                        alert('Event Update');
                    }
                })
            },
            eventDrop:function(event)
            {
                var start = $.fullCalendar.formatDate(event.start, 'Y/MM/DD HH:mm:ss');
                var end = $.fullCalendar.formatDate(event.end, 'Y/MM/DD HH:mm:ss');
                var title = event.title;
                var id = event.id;
                $.ajax({
                    url:"/update",
                    type:"POST",
                    data:{title:title, start:start, end:end, id:id},
                    success:function(){
                        calendar.fullCalendar('refetchEvents');
                        alert('Event Update');
                    }
                })
            },
            eventClick:function(event)
            {
                if(confirm("Are you sure you want to remove ir?"))
                {
                    var id = event.id;
                    $.ajax({
                    url:"/ajax_delete",
                    type:"POST",
                    data:{id:id},
                    success:function(){
                        calendar.fullCalendar('refetchEvents');
                        alert('Event Removed');
                    }
                })
                }
            },

        });
        calendar.render()
    });

  </script>
{% endblock script %}


